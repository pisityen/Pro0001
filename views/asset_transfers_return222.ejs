<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Asset</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/bar.css" />
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <div class="main-container d-flex">

    <!-- Sidebar -->
    <div class="sidebar bg-dark text-white vh-100 d-flex flex-column" id="side_nav">
      <!-- ส่วนเนื้อหาใน Sidebar -->
      <div class="header-box px-3 pt-3 pb-4 d-flex justify-content-between align-items-center">
        <h1 class="fs-5 text-uppercase">
          <span class="bg-white text-dark rounded shadow px-2 me-2">Test</span>
          <span class="text-white">Project</span>
        </h1>
      </div>
      <ul class="list-unstyled px-2">
        <li class="mb-2">
          <a href="/dashboard" class="text-decoration-none px-3 py-2 d-block rounded text-white active-link">
            <i class="fas fa-home me-2"></i> Dashboard
          </a>
        </li>
        <li class="mb-2">
          <a href="#assetSubmenu" class="text-decoration-none px-3 py-2 d-block text-white " data-bs-toggle="collapse">
            <i class="fas fa-home me-2"></i>Asset
          </a>
          <ul class="collapse list-unstyled px-3" id="assetSubmenu">
            <% if (role === 'admin') { %><li><a href="/asset_management" class="text-decoration-none px-3 py-2 d-block text-white">Asset Management</a></li><% } %>
            <li><a href="/asset_requests" class="text-decoration-none px-3 py-2 d-block text-white">Asset Required</a></li>
            <li><a href="/all_transfers" class="text-decoration-none px-3 py-2 d-block text-white">Asset Transfers</a></li>
            <li><a href="#" class="text-decoration-none px-3 py-2 d-block text-white">Asset Master</a></li>
          </ul>
        </li>
        <!-- <li class="mb-2">
          <a href="#employeetSubmenu" class="text-decoration-none px-3 py-2 d-block text-white " data-bs-toggle="collapse">
            <i class="fas fa-home me-2"></i>Employee
          </a>
          <ul class="collapse list-unstyled px-3" id="employeetSubmenu">
            <li><a href="#" class="text-decoration-none px-3 py-2 d-block text-white">Employee Required</a></li>
            <li><a href="#" class="text-decoration-none px-3 py-2 d-block text-white">Employee Master</a></li>
          </ul>
        </li> -->
        <li class="mb-2">
          <% if (role === 'admin') { %><a href="/account" class="text-decoration-none px-3 py-2 d-block rounded text-white active-link">
            <i class="fas fa-home me-2"></i> Account
          </a><% } %>
        </li>
      </ul>
      <div class="mt-auto px-2 pb-3 text-center">
        <div class="text-white mb-2">
          User : <%= user_name %>
        </div>
        <div class="text-white mb-2">
          Role : <%= role %>
        </div>
        <a href="/logout" class="btn btn-danger text-decoration-none px-3 py-2 w-100">
          <i class="fas fa-sign-out-alt me-2"></i> Logout
        </a>
      </div>
    </div>
    <!-- End Sidebar -->

    <!-- Main Content -->
    <div class="content flex-fill">
      <!-- ส่วนบน (ถ้าต้องการ Navbar หรือ Title) -->
      <nav class="navbar navbar-light bg-light px-3">
        <div class="container-fluid">
          <h2 class="navbar-brand fs-5">Transfer Asset</h2>
        </div>
      </nav>

      <div class="container mt-4">
        <h3>คืนทรัพย์สินที่รับไปแล้ว</h3>
        <form id="returnForm">
          <!-- เหตุผล -->
          <div class="mb-3">
            <label for="reason" class="form-label">เหตุผลการคืน</label>
            <textarea id="reason" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <select name="transfer_type" id="transfer_type" class="form-select">
              <option value="Request">Request</option>
              <option value="Return">Return</option>
            </select>
          </div>

          <!-- Container สำหรับ checkbox -->
          <div id="assignedContainer" class="mb-3">
            กำลังโหลดรายการทรัพย์สิน...
          </div>

          <button type="submit" class="btn btn-primary">ยืนยันการคืน</button>
        </form>


      </div>
    </div>
    <!-- End Main Content -->

  </div>
  <!-- End main-container -->

  <script>
    // 1) เมื่อหน้าโหลด ให้ fetch รายการAssigned
    fetch('/asset_transfers_return/assigned')
      .then(r => r.json())
      .then(list => {
        const ctn = document.getElementById('assignedContainer');
        if (!list.length) {
          ctn.innerHTML = '<p>ไม่พบทรัพย์สินที่รับไปแล้ว</p>';
          return;
        }
        // สร้าง checkbox แต่ละรายการ
        ctn.innerHTML = list.map(item => `
          <div class="form-check">
            <input class="form-check-input return-as" 
                   type="checkbox" 
                   value="${item.as_asset_number}" 
                   id="as_${item.as_asset_number}">
            <label class="form-check-label" for="as_${item.as_asset_number}">
              ${item.as_asset_number} — ${item.as_name} (${item.as_category})
            </label>
          </div>
        `).join('');
      })
      .catch(err => {
        document.getElementById('assignedContainer')
                .innerHTML = '<p class="text-danger">ไม่สามารถโหลดรายการได้</p>';
        console.error(err);
      });
  
    // 2) เมื่อ submit ฟอร์ม Return
    document.getElementById('returnForm').addEventListener('submit', async e => {
      e.preventDefault();
      const reason = document.getElementById('reason').value.trim();
      // เก็บ AS ที่ถูกติ๊ก
      const checked = Array.from(document.querySelectorAll('.return-as:checked'))
                           .map(cb => cb.value);
      if (!checked.length) {
        return alert('กรุณาเลือกทรัพย์สินที่จะคืนอย่างน้อยหนึ่งรายการ');
      }
      // เรียก API Return
      const resp = await fetch('/asset_transfers_return/return', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          transfer_number: null,         // หรือคุณไม่จำเป็นต้องกำหนดเลขใบใหม่ เพราะ API จะสร้างเอง
          as_asset_numbers: checked,
          reason
        })
      });
      const j = await resp.json();
      if (!resp.ok) {
        return alert('Error: ' + (j.error||j.message));
      }
      alert(j.message);
      // โหลดหน้าซ้ำหรือเปลี่ยนหน้าไปดูประวัติ
      window.location.reload();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
